let UP$1="up",D="down",R="right",L="left";var directions={UP:UP$1,D:D,R:R,L:L,BACK:"back",ALL:[UP$1,D,L,R]},modes=["Braille","Visual Morse","Morse"];let Interactable=function(t,e,i){this.g=t,this.active=!1,this.action=e||{},this.stop=i||{}};Interactable.prototype.activate=function(){this.active||(this.active=!0,this.action())},Interactable.prototype.deactivate=function(){this.active=!1,this.stop()};let n="C3",d=1,b=3,spaceNote="-",spaceLen=7,el=3,Morse={a:[{n:n,l:d},{n:n,l:b}],b:[{n:n,l:b},{n:n,l:d},{n:n,l:d},{n:n,l:d}],c:[{n:n,l:b},{n:n,l:d},{n:n,l:b},{n:n,l:d}],d:[{n:n,l:b},{n:n,l:d},{n:n,l:d}],e:[{n:n,l:d}],f:[{n:n,l:d},{n:n,l:d},{n:n,l:b},{n:n,l:d}],g:[{n:n,l:b},{n:n,l:b},{n:n,l:d}],h:[{n:n,l:d},{n:n,l:d},{n:n,l:d},{n:n,l:d}],i:[{n:n,l:d},{n:n,l:d}],j:[{n:n,l:d},{n:n,l:b},{n:n,l:b},{n:n,l:b}],k:[{n:n,l:b},{n:n,l:d},{n:n,l:b}],l:[{n:n,l:d},{n:n,l:b},{n:n,l:d},{n:n,l:d}],m:[{n:n,l:b},{n:n,l:b}],n:[{n:n,l:b},{n:n,l:d}],o:[{n:n,l:b},{n:n,l:b},{n:n,l:b}],p:[{n:n,l:d},{n:n,l:b},{n:n,l:b},{n:n,l:d}],q:[{n:n,l:b},{n:n,l:b},{n:n,l:d},{n:n,l:b}],r:[{n:n,l:d},{n:n,l:b},{n:n,l:d}],s:[{n:n,l:d},{n:n,l:d},{n:n,l:d}],t:[{n:n,l:b}],u:[{n:n,l:d},{n:n,l:d},{n:n,l:b}],v:[{n:n,l:d},{n:n,l:d},{n:n,l:d},{n:n,l:b}],w:[{n:n,l:d},{n:n,l:b},{n:n,l:b}],x:[{n:n,l:b},{n:n,l:d},{n:n,l:d},{n:n,l:b}],y:[{n:n,l:b},{n:n,l:d},{n:n,l:b},{n:n,l:b}],z:[{n:n,l:b},{n:n,l:b},{n:n,l:d},{n:n,l:d}],period:[{n:n,l:d},{n:n,l:b},{n:n,l:d},{n:n,l:b},{n:n,l:d},{n:n,l:b}],comma:[{n:n,l:b},{n:n,l:b},{n:n,l:d},{n:n,l:d},{n:n,l:b},{n:n,l:b}],question:[{n:n,l:d},{n:n,l:d},{n:n,l:b},{n:n,l:b},{n:n,l:d},{n:n,l:d}],exclamation:[{n:n,l:b},{n:n,l:d},{n:n,l:b},{n:n,l:d},{n:n,l:b},{n:n,l:b}],space:[{n:spaceNote,l:spaceLen}],endL:[{n:spaceNote,l:el}]};function charToMorse(t){switch(t){case" ":return Morse.space;case".":return Morse.period;case",":return Morse.comma;case"?":return Morse.question;case"!":return Morse.exclamation;default:return Morse[t]}}let MorseActions={toMorse:function(t){let e=[];return t.split(" ").forEach(t=>{for(let i=0;i<t.length;i++)e.push({ch:t[i],code:charToMorse(t[i])}),e.push({ch:"|",code:Morse.endL});e.pop(),e.push({ch:" ",code:charToMorse(" ")})}),e}};var enharmonics="B#-C|C#-Db|D|D#-Eb|E-Fb|E#-F|F#-Gb|G|G#-Ab|A|A#-Bb|B-Cb",middleC=440*Math.pow(Math.pow(2,1/12),-9),numeric=/^[0-9.]+$/,octaveOffset=4,space=/\s+/,num=/(\d+)/,offsets={};function Note(t){var e=t.split(space);this.frequency=Note.getFrequency(e[0])||0,this.duration=Note.getDuration(e[1])||0}function Sequence(t,e,i){this.ac=t||new AudioContext,this.createFxNodes(),this.tempo=e||120,this.loop=!0,this.smoothing=0,this.staccato=0,this.notes=[],this.push.apply(this,i||[])}let seq;enharmonics.split("|").forEach((function(t,e){t.split("-").forEach((function(t){offsets[t]=e}))})),Note.getFrequency=function(t){var e=t.split(num),i=offsets[e[0]],s=(e[1]||octaveOffset)-octaveOffset;return middleC*Math.pow(Math.pow(2,1/12),i)*Math.pow(2,s)},Note.getDuration=function(t){return numeric.test(t)?parseFloat(t):t.toLowerCase().split("").reduce((function(t,e){return t+("w"===e?4:"h"===e?2:"q"===e?1:"e"===e?.5:"s"===e?.25:0)}),0)},Sequence.prototype.createFxNodes=function(){var t=this.gain=this.ac.createGain();return[["bass",100],["mid",1e3],["treble",2500]].forEach(function(e,i){(i=this[e[0]]=this.ac.createBiquadFilter()).type="peaking",i.frequency.value=e[1],t.connect(t=i)}.bind(this)),t.connect(this.ac.destination),this},Sequence.prototype.push=function(){return Array.prototype.forEach.call(arguments,function(t){this.notes.push(t instanceof Note?t:new Note(t))}.bind(this)),this},Sequence.prototype.createCustomWave=function(t,e){e||(e=t),this.waveType="custom",this.customWave=[new Float32Array(t),new Float32Array(e)]},Sequence.prototype.createOscillator=function(){return this.stop(),this.osc=this.ac.createOscillator(),this.customWave?this.osc.setPeriodicWave(this.ac.createPeriodicWave.apply(this.ac,this.customWave)):this.osc.type=this.waveType||"square",this.osc.connect(this.gain),this},Sequence.prototype.scheduleNote=function(t,e){var i=60/this.tempo*this.notes[t].duration,s=i*(1-(this.staccato||0));return this.setFrequency(this.notes[t].frequency,e),this.smoothing&&this.notes[t].frequency&&this.slide(t,e,s),this.setFrequency(0,e+s),e+i},Sequence.prototype.getNextNote=function(t){return this.notes[t<this.notes.length-1?t+1:0]},Sequence.prototype.getSlideStartDelay=function(t){return t-Math.min(t,60/this.tempo*this.smoothing)},Sequence.prototype.slide=function(t,e,i){var s=this.getNextNote(t),n=this.getSlideStartDelay(i);return this.setFrequency(this.notes[t].frequency,e+n),this.rampFrequency(s.frequency,e+i),this},Sequence.prototype.setFrequency=function(t,e){return this.osc.frequency.setValueAtTime(t,e),this},Sequence.prototype.rampFrequency=function(t,e){return this.osc.frequency.linearRampToValueAtTime(t,e),this},Sequence.prototype.play=function(t){return t="number"==typeof t?t:this.ac.currentTime,this.createOscillator(),this.osc.start(t),this.notes.forEach(function(e,i){t=this.scheduleNote(i,t)}.bind(this)),this.osc.stop(t),this.osc.onended=this.loop?this.play.bind(this,t):null,this},Sequence.prototype.stop=function(){return this.osc&&(this.osc.onended=null,this.osc.disconnect(),this.osc=null),this};let MusicActions={playMusic:function(t,e){seq&&seq.stop(),(seq=new Sequence(null,e,t)).loop=!1,seq.staccato=.5,seq.gain.gain.value=.5,seq.createCustomWave([-.8,1,.8,.8,-.8,-.8,-1]),seq.play()},stopMusic:function(){seq&&seq.stop()}},Braille={a:[1,0,0,0,0,0],b:[1,0,1,0,0,0],c:[1,1,0,0,0,0],d:[1,1,0,1,0,0],e:[1,0,0,1,0,0],f:[1,1,1,0,0,0],g:[1,1,1,1,0,0],h:[1,0,1,1,0,0],i:[0,1,1,0,0,0],j:[0,1,1,1,0,0],k:[1,0,0,0,1,0],l:[1,0,1,0,1,0],m:[1,1,0,0,1,0],n:[1,1,0,1,1,0],o:[1,0,0,1,1,0],p:[1,1,1,0,1,0],q:[1,1,1,1,1,0],r:[1,0,1,1,1,0],s:[0,1,1,0,1,0],t:[0,1,1,1,1,0],u:[1,0,0,0,1,1],v:[1,0,1,0,1,1],w:[0,1,1,1,0,1],x:[1,1,0,0,1,1],y:[1,1,0,1,1,1],z:[1,0,0,1,1,1],space:[0,0,0,0,0,0],exclamation:[0,0,1,1,1,0],comma:[0,0,1,0,0,0],period:[0,0,1,1,0,1],question:[0,0,1,0,1,1]};function convert(t){switch(t){case" ":return Braille.space;case"!":return Braille.exclamation;case",":return Braille.comma;case".":return Braille.period;case"?":return Braille.question;default:return Braille[t]}}function toBraille(t){let e=[];return t.split(" ").forEach(t=>{for(let i=0;i<t.length;i++)e.push({ch:t[i],dots:convert(t[i])});e.push({ch:" ",dots:convert(" ")})}),e}let noteList=[],Statue=function(t,e){Interactable.call(this,t),this.sprite=t.rectangle(48,64,"gray"),this.scene=t.group(),this.sprites=[],this.modal={},this.mode=e};Statue.prototype=Object.create(Interactable.prototype),Statue.prototype.initialize=function(t,e){this.mode===modes[0]?(this.action=()=>this.showBraille(toBraille(t),this.scene,e),this.stop=this.closeModal):this.mode===modes[1]?(this.action=()=>this.showMorse(MorseActions.toMorse(t),this.scene,e),this.stop=this.closeModal):(noteList=[],this.action=()=>this.playMorse(MorseActions.toMorse(t)),this.stop=this.stopMorse)},Statue.prototype.stopMorse=function(){MusicActions.stopMusic(),this.closeModal()},Statue.prototype.closeModal=function(){this.g.remove(this.modal),this.g.remove(this.sprites)},Statue.prototype.playMorse=function(t){let e=this.g.canvas.width,i=this.g.canvas.height/10;if(this.modal=this.g.rectangle(e/2,i,"teal","black",1,e/4,i),this.sprites=[this.g.text("Playing morse","30px Times","black",0,0)],this.scene.addChild(this.modal),this.modal.putLeft(this.sprites[0],e/5,-10),0===noteList.length){let e=[];t.map((t,i)=>{t.code.map(t=>{e.push(`${t.n} ${t.l}`)})}),noteList=e}MusicActions.playMusic(noteList,this.g.tempo)},Statue.prototype.showMorse=function(t,e,i=!1){let s=30,n=this.g.canvas.height/10,r=n,o=[],h=2,a=this.g.canvas.width-30,l="";i&&(l=t[0].ch),t.map(t=>{if(30*t.code.length+s>=a&&(s=30,r+=20,h++),t.ch===l){let t=this.g.text(l,"20px Times","yellow",s,r-5);o.push(t),s+=15}else t.code.map((e,i)=>{1===e.l?(o.push(this.g.circle(10,"black","black",1,s,r)),s+=15):3===e.l&&"|"!==t.ch?(o.push(this.g.rectangle(30,10,"black","black",1,s,r)),s+=35):"|"===t.ch?(o.push(this.g.rectangle(1,10,"red","red",1,s,r)),s+=6):7===e.l&&(o.push(this.g.rectangle(30,.5,"red","red",1,s,r+5)),s+=35)})}),this.modal=this.g.rectangle(a,10*h*2,"teal","black",1,15,n-10),this.sprites=o,e.addChild(this.modal),e.add(o)},Statue.prototype.showBraille=function(t,e,i=!1){let s=15,n=this.g.canvas.height/10,r=n,o=[],h=2,a=this.g.canvas.width-15,l="";i&&(l=t[0].ch),t.map(t=>{if(30+s>=a&&(s=15,r+=50,h++),t.ch===l){let t=this.g.text(l,"40px Times","yellow",s+5,r);o.push(t)}else t.dots.map((t,e)=>{let i=s+e%2*15,n=r+15*Math.floor(e/2);o.push(this.g.circle(10,1===t?"black":"teal","black",1,i,n))});s+=35}),this.sprites=o,this.modal=this.g.rectangle(a,15*h*3,"teal","black",1,7.5,n-15),e.addChild(this.modal),e.add(o)};let Pit=function(t,e){let i=0,s=0,n=t.canvas.width,r=t.canvas.height;e===directions.UP?(i=n/2-18,s=0):e===directions.D?(i=n/2-18,s=r-36):e===directions.L?(i=0,s=r/2-18):e===directions.R&&(i=n-36,s=r/2-18),this.sprite=t.rectangle(36,36,"black","black",1,i,s),this.dir=e},StatueRoom=function(t,e,i){this.g=t,this.player=t.player,this.loadNext=i,this.mode=e,this.statue=new Statue(t,e),this.canUseStatue=!1,this.pits=[new Pit(t,directions.UP),new Pit(t,directions.D),new Pit(t,directions.L),new Pit(t,directions.R)],t.stage.putCenter(this.statue.sprite),this.pitSprites=this.pits.map(t=>t.sprite),this.scene=t.group(this.statue.sprite,this.pitSprites[0],this.pitSprites[1],this.pitSprites[2],this.pitSprites[3]),this.scene.visible=!1,this.actionKey=t.keyboard(70),this.cancelKey=t.keyboard(68),this.actionKey.press=()=>{this.canUseStatue&&!this.statue.active&&(this.scene.alpha=.1,this.player.sprite.alpha=.1,this.statue.activate())},this.cancelKey.press=()=>{this.statue.active&&(this.scene.alpha=1,this.player.sprite.alpha=1,this.statue.deactivate())}};StatueRoom.prototype.load=function(t,e){this.statue.initialize(t.toLowerCase(),e),this.g.stage.putCenter(this.player.sprite,0,100)},StatueRoom.prototype.placePlayer=function(t){let e,i,s=this.pitSprites[0].width;t===directions.UP?(i=2*s-this.g.canvas.height/2,e=0):t===directions.D?(e=0,i=this.g.canvas.height/2-2*s):t===directions.L?(e=2*s-this.g.canvas.width/2,i=0):t===directions.R&&(e=this.g.canvas.width/2-2*s,i=0),this.g.stage.putCenter(this.player.sprite,e,i)},StatueRoom.prototype.loop=function(){this.statue.active||this.g.move(this.player.sprite),this.g.contain(this.player.sprite,this.g.stage.localBounds),this.g.rectangleCollision(this.player.sprite,this.statue.sprite)&&this.player.sprite.direction===directions.UP&&(this.canUseStatue=!0),this.player.sprite.direction!==directions.UP&&(this.canUseStatue=!1),this.pits.forEach(t=>{this.g.hitTestRectangle(this.player.sprite,t.sprite)&&this.loadNext(t.dir)})};let Spikes=function(t,e){let i,s,n,r,o=t.canvas.width,h=t.canvas.height;e===directions.UP?(s=0,i=0,n=o,r=36):e===directions.D?(i=0,s=h-36,n=o,r=36):e===directions.L?(i=0,s=0,n=36,r=h):e===directions.R&&(i=o-36,s=0,n=36,r=h),this.sprite=t.rectangle(n,r,"grey","grey",1,i,s),this.sprite.alpha=.5,this.side=e},Actor=function(t,e,i,s){this.g=t,this.hp=e,this.invinc=!1,this.invinceTime=i||1e3,this.dead=!1,this.healthWidth=s,this.hSprite=t.rectangle(this.healthWidth*this.hp,this.healthWidth,"purple"),this.hSprite.visible=!1,this.hSprite.alpha=.5};Actor.prototype.show=function(){this.sprite.visible=!0,this.hSprite.visible=!0},Actor.prototype.hide=function(){this.sprite.visible=!1,this.hSprite.visible=!1},Actor.prototype.stopMoving=function(){this.sprite.vx=0,this.sprite.vy=0},Actor.prototype.heal=function(t){this.hp+=t,this.hSprite.width+=this.healthWidth*t},Actor.prototype.takeDamage=function(t,e){if(this.invinc)return;if(this.hp-=t,this.hp<=0)return this.dead=!0,void(this.hSprite.width=0);this.invinc=!0,this.sprite.alpha=.5,this.hSprite.width-=this.healthWidth*t;switch(this.loseInvincibility(this.invinceTime),e){case"right":this.sprite.x-=40;break;case"left":this.sprite.x+=40;break;case"up":this.sprite.y+=40;break;case"down":this.sprite.y-=40}},Actor.prototype.loseInvincibility=function(t){this.g.wait(t,()=>{this.invinc=!1,this.sprite.alpha=1})},Actor.prototype.moveHealth=function(){this.hSprite.x=this.sprite.x,this.hSprite.y=this.sprite.y-this.healthWidth};let Enemy=function(t,e){this.sprite=t.rectangle(32,32,"red"),Actor.call(this,t,e,500,10),this.dmg=1,this.speed=1,this.show()};Enemy.prototype=Object.create(Actor.prototype);const getRand=function(t){return Math.floor(Math.random()*Math.abs(t))},toRadians=function(t){return t*(Math.PI/180)},reverseDirection=function(t){switch(t){case directions.R:return directions.L;case directions.L:return directions.R;case directions.UP:return directions.D;case directions.D:return directions.UP}};let Boss=function(t,e){this.ps=e,this.sprite=t.rectangle(64,64,"red"),Actor.call(this,t,20,400,10),this.sprite.visible=!1,this.hSprite.visible=!1,this.dmg=1.3,this.speed=3,this.box=t.rectangle(128,128,"red"),this.box.visible=!1,this.g.wait(2*this.invinceTime,()=>this.warp())};Boss.prototype=Object.create(Actor.prototype),Boss.prototype.takeDamage=function(t,e){if(!this.invinc){if(this.hp-=t,this.hp<=0)return this.dead=!0,void(this.hSprite.width=0);this.invinc=!0,this.hSprite.width-=this.healthWidth*t,this.speed=0,this.sprite.alpha=.5,this.g.wait(this.invinceTime,()=>this.delayWarp())}},Boss.prototype.delayWarp=function(){this.sprite.visible=!1,this.hSprite.visible=!1,this.g.wait(this.invinceTime,()=>this.warp())},Boss.prototype.warp=function(){let t,e,i=this.ps.x,s=this.ps.y,n=this.g.canvas.width/2;do{t=getRand(360),e=this.g.rotateAroundPoint(i,s,n,n,toRadians(t)),this.box.x=e.x,this.box.y=e.y}while(this.g.hitTestRectangle(this.box,this.ps));this.sprite.x=e.x+32,this.sprite.y=e.y+32,this.invinc=!1,this.speed=3,this.sprite.alpha=1,this.show()};class TextUtil{constructor(t){this.g=t}centeredTexts(t,e,i,s,n){const r=this.g,o=.2*e;let h=1===t.length?t[0].length:t.reduce((t,e)=>t.length>e.length?t.length:e.length);return t.map((t,a)=>r.text(t,`${e}px monospace`,i,r.stage.halfWidth-h/2*((e+o)/2),s+n*a))}}let GameOver=function(t,e){new TextUtil(t).centeredTexts(e,40,"black",t.stage.halfHeight-40*(e.length-1),40);return()=>{}},EnemyRoom=function(t,e){this.g=t,this.player=t.player,this.sword=t.player.sword,this.exitPit=t.rectangle(50,50,"yellow"),this.loadNext=e,this.spikes=[new Spikes(t,directions.UP),new Spikes(t,directions.D),new Spikes(t,directions.L),new Spikes(t,directions.R)],this.scene=t.group(this.exitPit,this.spikes[0].sprite,this.spikes[1].sprite,this.spikes[2].sprite,this.spikes[3].sprite),this.scene.visible=!1,this.fromDir="",this.enemies=[],this.treasure=null,this.hasTreasure=!1,this.canOpen=!1,this.deathCount=0,this.deathMax=30,this.actionKey=t.keyboard(70),this.actionKey.press=()=>{this.canOpen?this.treasure.activate():!this.sword.active&&this.scene.visible&&this.sword.startSwing(this.player.sprite.direction,this.player.sprite.x+this.player.sprite.halfWidth,this.player.sprite.y-this.player.sprite.halfHeight)}};EnemyRoom.prototype.load=function(t,e,i,s,n){this.g.stage.putCenter(this.player.sprite,0,0),this.exitPit.visible=!1,this.g.stage.putCenter(this.exitPit,0,-50),this.fromDir=t,this.hasTreasure=s,e||(s?(this.loadEnemies(Math.floor(1.5*i),2),this.treasure=n,this.scene.addChild(n.sprite)):this.loadEnemies(i,1),this.enemies.length>0&&this.placeEnemies())},EnemyRoom.prototype.loadBoss=function(){this.g.stage.putCenter(this.player.sprite,0,0),this.enemies.push(new Boss(this.g,this.player.sprite)),this.exitPit.visible=!1,this.g.stage.putCenter(this.exitPit,0,-50)},EnemyRoom.prototype.loadEnemies=function(t,e){for(let i=0;i<t;i++)this.enemies.push(new Enemy(this.g,e))},EnemyRoom.prototype.placeEnemies=function(){let t=360/this.enemies.length,e=0,i=this.g.canvas.width/2,s=this.g.canvas.height/2,n=this.g.canvas.width/4;this.enemies.forEach((r,o)=>{let h=this.g.rotateAroundPoint(i,s,n,n,toRadians(e));e+=t,r.sprite.x=h.x,r.sprite.y=h.y})},EnemyRoom.prototype.loop=function(){let t=this.player.sprite;if(this.player.dead)return this.deathCount++,this.scene.alpha-=.02,void(this.deathCount>=this.deathMax&&(this.g.state=new GameOver(this.g,["You have died"])));if(this.sword.active||this.g.move(t),0==t.vx&&0==t.vy||(this.canOpen=!1),this.g.contain(t,this.g.stage.localBounds),this.exitPit.visible&&this.g.hitTestRectangle(t,this.exitPit)&&this.loadNext(directions.BACK,this.fromDir),this.hasTreasure&&this.treasure.sprite.visible&&this.g.rectangleCollision(t,this.treasure.sprite)&&(this.canOpen=!0),this.spikes.forEach(e=>{this.g.hitTestRectangle(t,e.sprite)&&this.player.takeDamage(1,e.side)}),this.sword.active&&(this.g.rotateAroundSprite(this.sword.sprite,t,t.width,this.sword.degrees),this.sword.swing()),0!==this.enemies.length||this.exitPit.visible)for(let e=this.enemies.length-1;e>=0;e--){let i=this.enemies[e];if(this.sword.active&&!i.invinc){this.g.hitTestRectangle(this.sword.sprite,i.sprite)&&i.takeDamage(this.sword.dmg,reverseDirection(t.direction),t)}if(i.dead)this.g.remove(i.sprite),this.g.remove(i.hSprite),this.enemies.splice(e,1);else if(i.sprite.visible&&(this.g.followConstant(i.sprite,t,i.speed),this.g.contain(i.sprite,this.g.stage.localBounds),i.moveHealth(),!this.player.invinc)){let e=this.g.rectangleCollision(t,i.sprite,!0);e&&this.player.takeDamage(i.dmg,e)}}else this.g.hitTestRectangle(this.exitPit,t)&&(this.exitPit.y=50),this.exitPit.visible=!0,this.hasTreasure&&(this.treasure.sprite.visible=!0,this.g.stage.putCenter(this.treasure.sprite,0,this.g.canvas.height/4))};let Treasure=function(t,e,i,s){Interactable.call(this,t,()=>{this.open(),s()},{}),this.name=e,this.desc=i,this.sprite=t.rectangle(32,32,"gold"),this.sprite.visible=!1,this.scene={},this.textUtils=new TextUtil(t)};Treasure.prototype=Object.create(Interactable.prototype),Treasure.prototype.open=function(){const t=this.g;let e=t.canvas.height/4;this.sprite.fillStyle="brown";let i=t.rectangle(t.canvas.width,t.canvas.height/2,"teal","teal",1,0,e-50),s=this.textUtils.centeredTexts(["You found a",`${this.name}`],48,"black",e,50),n=this.textUtils.centeredTexts([`${this.desc}`],32,"black",e+100,35);this.scene=t.group(i,s[0],s[1],n[0]),this.g.wait(1500,()=>this.hideModal())},Treasure.prototype.hideModal=function(){this.scene.visible=!1};let templates=["Your path is $g.","$g is good.","Danger $b, $b, and $b.","$g","Go $g","Hark! $g lies in safety.","Fight or be conquered at $b, $b, and $b"],treasureTemplates=["$t holds fortune, but $g is the way forward.","$g to proceed. If treasure you seek then go $t.","$t shines, $b and $b are dark."],dirs={up:["north","up","ahead"],down:["south","down","behind"],left:["west","left"],right:["east","right"]};function parse(t,e,i=!1,s){let n=directions.ALL;i&&(t=t.replace(/\$t/g,dirs[s][getRand(dirs[s].length)]),n=n.filter(t=>t!=s)),n=n.filter(t=>t!=e);let r=dirs[e][getRand(dirs[e].length)];return t=t.replace("$g",r),n.forEach(e=>t=t.replace("$b",dirs[e][getRand(dirs[e].length)])),t}function normSen(t){let e=templates[getRand(templates.length)];return e=parse(e,t)}function treasureSen(t,e=UP){let i=treasureTemplates[getRand(treasureTemplates.length)];return i=parse(i,t,!0,e)}let getSentence=function(t,e,i){return e?treasureSen(t,i):normSen(t)},Maze=function(t,e){switch(this.g=t,this.player=t.player,this.level=0,this.endLevel=10,this.goodDir="",this.treasureDir="",this.mode=e,this.statueRoom=new StatueRoom(this.g,e,function(t){this.loadNext(t)}.bind(this)),this.enemyRoom={},this.treasureRoom={},this.explored=[],this.showingChar=!1,this.shownSprite=null,this.treasures=[new Treasure(this.g,"Potion","HP up 5",()=>this.g.player.heal(5)),new Treasure(this.g,"Sword","Damage up 1",()=>this.g.player.sword.dmg+=1)],e){case modes[0]:case modes[1]:this.treasures.push(new Treasure(this.g,"Dictionary","A character is revealed",function(){this.showingChar=!0}.bind(this)));break;case modes[2]:this.treasures.push(new Treasure(this.g,"Monochrome","Morse speed down",function(){this.g.tempo-=60}.bind(this)))}return this.dirs=directions.ALL,this.room=this.statueRoom,this.numWrongRooms=0,this.levelText=t.text(`${this.level}`,"28px sans-serif","black"),this.levelText.layer=1e3,this.loadNext(this.goodDir),t.player.show(),()=>this.loop()};Maze.prototype.loadNext=function(t,e){if(this.level===this.endLevel)return void this.endGame();this.room.scene.visible=!1,this.player.invinc=!0,this.player.loseInvincibility();let i=this.numWrongRooms/2;if(t===directions.BACK)this.statueRoom.placePlayer(e),this.room=this.statueRoom;else if(t===this.goodDir)this.enterNextLevel();else if(t===this.treasureDir){if(this.explored.includes(t))this.treasureRoom.load(t,!0,i,!0,{});else{let e=getRand(this.treasures.length);this.treasureRoom.load(t,!1,i,!0,this.treasures.splice(e,1)[0])}this.room=this.treasureRoom,this.explored.push(t)}else this.enemyRoom.load(t,this.explored.includes(t),i,!1),this.room=this.enemyRoom,this.explored.includes(t)||(this.explored.push(t),this.numWrongRooms++);this.room.scene.visible=!0,this.player.stopMoving()},Maze.prototype.enterNextLevel=function(){this.level++,this.enemyRoom=new EnemyRoom(this.g,function(t,e){this.loadNext(t,e)}.bind(this)),this.treasureRoom=new EnemyRoom(this.g,function(t,e){this.loadNext(t,e)}.bind(this)),this.levelText.content=`lv ${this.level}`;let t=getRand(this.dirs.length);if(this.goodDir=this.dirs[t],this.level===this.endLevel){if(0!==this.treasures.length)return void this.endGame();this.enemyRoom.loadBoss(),this.room=this.enemyRoom}else{let e,i=getRand(this.endLevel-this.level)<this.treasures.length;if(i){do{e=getRand(this.dirs.length)}while(e===t);this.treasureDir=this.dirs[e]}else this.treasureDir="";this.statueRoom.load(getSentence(this.goodDir,i,this.treasureDir),this.showingChar),this.explored=[],this.room=this.statueRoom}},Maze.prototype.endGame=function(){this.room.scene.alpha=0,this.player.hide(),this.player.sword.sprite.visible=!1,this.g.state=new GameOver(this.g,0===this.treasures.length?["You found the kids","and made it back.","Congratulations hero."]:["You made it back,","but the kids were","never seen again."])},Maze.prototype.loop=function(){this.room.loop();let t=this.g.canvas.width/2;this.g.stage.putTop(this.levelText,t-50,20),this.g.stage.putTop(this.player.hSprite,-t+this.player.hSprite.halfWidth+10,40)};let Menu=function(t){this.g=t;let e=t.stage.height/4,i=t.stage.width/2.5;return this.selected=0,this.actions=modes.map((s,n)=>new Button(t,s,i,e+50*n,15*s.length,20)),this.actions[0].select(),this.actionKey=t.keyboard(70),this.cancelKey=t.keyboard(68),t.key.upArrow.press=()=>{this.select(-1)},t.key.downArrow.press=()=>{this.select(1)},this.actionKey.press=()=>{this.actions.forEach(t=>{this.g.remove(t.scene)}),this.actionKey.press=null,this.cancelKey.press=null,t.state=new Maze(this.g,modes[this.selected])},()=>{}};Menu.prototype.select=function(t){this.actions[this.selected].deselect(),this.selected=(this.selected+=t)%this.actions.length,this.selected<0&&(this.selected=this.actions.length-1),this.actions[this.selected].select()};let Button=function(t,e,i,s,n,r){this.text=t.text(e,"20px Monospace","black",i,s),this.rect=t.rectangle(n,r,"gray","black",1,i-10,s),this.scene=t.group(this.rect,this.text)};Button.prototype.select=function(){this.rect.fillStyle="teal"},Button.prototype.deselect=function(){this.rect.fillStyle="gray"};let Sword=function(t){this.degrees=0,this.active=!1,this.sprite=t.rectangle(40,5,"gray"),this.sprite.visible=!1,this.sprite.rotation=0,this.deltaAngle=Math.PI/16,this.frame=0,this.dmg=1,this.maxFrame=12};Sword.prototype.startSwing=function(t,e,i){switch(t){case"left":this.degrees=Math.PI/2;break;case"right":this.degrees=3*Math.PI/2;break;case"up":this.degrees=Math.PI;break;case"down":this.degrees=0}this.sprite.x=e,this.sprite.y=i,this.sprite.rotation=this.degrees,this.sprite.visible=!0,this.active=!0},Sword.prototype.swing=function(){this.degrees+=this.deltaAngle,this.sprite.rotation=this.degrees,this.frame++,this.frame>this.maxFrame&&(this.active=!1,this.degrees=0,this.frame=0,this.sprite.visible=!1)};let Player=function(t){this.sprite=t.rectangle(32,32,"blue"),this.sprite.visible=!1,this.actionKey=t.keyboard(70),this.cancelKey=t.keyboard(68),t.fourKeyController(this.sprite,5,38,39,40,37),this.sword=new Sword(t),Actor.call(this,t,5,1e3,30)};Player.prototype=Object.create(Actor.prototype);var GA=GA||{};GA.VERSION="0.0.1",GA.plugins=void 0,GA.custom=void 0,GA.create=function(t,e,i,s,n){var r,o={};if(o.canvas=document.createElement("canvas"),o.canvas.setAttribute("width",1*t),o.canvas.setAttribute("height",1*e),o.canvas.style.backgroundColor="black",document.body.appendChild(o.canvas),o.canvas.ctx=o.canvas.getContext("2d"),o.stage=(c(r={}),r.stage=!0,r.width=o.canvas.width,r.height=o.canvas.height,r.x=0,r.y=0,r.parent=void 0,r),o.key=function(){var t={};return t.leftArrow=p(37),t.upArrow=p(38),t.rightArrow=p(39),t.downArrow=p(40),t}(),o.state=void 0,o.load=n||void 0,o.setup=i||void 0,void 0===o.setup)throw new Error("Please supply the setup function in the constructor");function h(){if(requestAnimationFrame(h,o.canvas),void 0===o._fps)l(),o.render(o.canvas,0);else{var t=Date.now(),e=t-o._startTime;for(e>1e3&&(e=o._frameDuration),o._startTime=t,o._lag+=e;o._lag>=o._frameDuration;)a(),l(),o._lag-=o._frameDuration;var i=o._lag/o._frameDuration;o.render(o.canvas,i)}}function a(){o.stage.children.forEach((function(t){!function t(e){e._previousX=e.x;e._previousY=e.y;e.children&&e.children.length>0&&e.children.forEach((function(e){t(e)}))}(t)}))}function l(){o.state&&!o.paused&&o.state()}function c(t){t.x=0,t.y=0,t.vx=0,t.vy=0,t.width=0,t.height=0,t.scaleX=1,t.scaleY=1,t.pivotX=.5,t.pivotY=.5,t.rotation=0,t.visible=!0,t.parent=void 0,t.stage=!1,t._alpha=1,t._layer=0,t._circular=!1,t._previousX=void 0,t._previousY=void 0,t.children=[],t.addChild=function(e){e.parent&&e.parent.removeChild(e),e.parent=t,t.children.push(e)},t.removeChild=function(e){if(e.parent!==t)throw new Error(e+"is not a child of "+t);t.children.splice(t.children.indexOf(e),1)},t.swapChildren=function(e,i){var s=t.children.indexOf(e),n=t.children.indexOf(i);if(-1===s||-1===n)throw new Error(child+" Both objects must be a child of the caller "+t);e.childIndex=n,i.childIndex=s,t.children[s]=i,t.children[n]=e},t.add=function(e){var i=Array.prototype.slice.call(arguments);i.length>1?i.forEach((function(e){t.addChild(e)})):t.addChild(i[0])},t.remove=function(e){var i=Array.prototype.slice.call(arguments);i.length>1?i.forEach((function(e){t.removeChild(e)})):t.removeChild(i[0])},t.setPosition=function(e,i){t.x=e,t.y=i};var e=t;t.putCenter=function(i,s,n){s=s||0,n=n||0,i.x=e.x+e.halfWidth-i.halfWidth+s,i.y=e.y+e.halfHeight-i.halfHeight+n,t.compensateForParentPosition(e,i)},t.putTop=function(i,s,n){s=s||0,n=n||0,i.x=e.x+e.halfWidth-i.halfWidth+s,i.y=e.y-i.height+n,t.compensateForParentPosition(e,i)},t.putRight=function(i,s,n){s=s||0,n=n||0,i.x=e.x+e.width+s,i.y=e.y+e.halfHeight-i.halfHeight+n,t.compensateForParentPosition(e,i)},t.putBottom=function(i,s,n){s=s||0,n=n||0,i.x=e.x+e.halfWidth-i.halfWidth+s,i.y=e.y+e.height+n,t.compensateForParentPosition(e,i)},t.putLeft=function(i,s,n){s=s||0,n=n||0,i.x=e.x-i.width+s,i.y=e.y+e.halfHeight-i.halfHeight+n,t.compensateForParentPosition(e,i)},t.compensateForParentPosition=function(t,e){0===e.parent.gx&&0===e.parent.gy||(e.x-=t.gx,e.y-=t.gy)},Object.defineProperties(t,{gx:{get:function(){return this.parent?this.x+this.parent.gx:this.x},enumerable:!0,configurable:!0},gy:{get:function(){return this.parent?this.y+this.parent.gy:this.y},enumerable:!0,configurable:!0},position:{get:function(){return{x:t.x,y:t.y}},enumerable:!0,configurable:!0},alpha:{get:function(){return t.parent._alpha*t._alpha},set:function(e){t._alpha=e},enumerable:!0,configurable:!0},halfWidth:{get:function(){return t.width/2},enumerable:!0,configurable:!0},halfHeight:{get:function(){return t.height/2},enumerable:!0,configurable:!0},centerX:{get:function(){return t.x+t.halfWidth},enumerable:!0,configurable:!0},centerY:{get:function(){return t.y+t.halfHeight},enumerable:!0,configurable:!0},layer:{get:function(){return t._layer},set:function(e){t._layer=e,t.parent.children.sort(u)},enumerable:!0,configurable:!0},circular:{get:function(){return t._circular},set:function(e){!0===e&&!1===t._circular&&(d(t),t._circular=!0),!1===e&&!0===t._circular&&(delete t.diameter,delete t.radius,t._circular=!1)},enumerable:!0,configurable:!0},localBounds:{get:function(){return{x:0,y:0,width:t.width,height:t.height}},enumerable:!0,configurable:!0},globalBounds:{get:function(){return rectangle={x:t.gx,y:t.gy,width:t.gx+t.width,height:t.gy+t.height},rectangle},enumerable:!0,configurable:!0},empty:{get:function(){return 0===t.children.length},enumerable:!0,configurable:!0}})}function d(t){Object.defineProperties(t,{diameter:{get:function(){return t.width},set:function(e){t.width=e,t.height=e},enumerable:!0,configurable:!0},radius:{get:function(){return t.width/2},set:function(e){t.width=2*e,t.height=2*e},enumerable:!0,configurable:!0}})}function p(t){var e={};return e.code=t,e.isDown=!1,e.isUp=!0,e.press=void 0,e.release=void 0,e.downHandler=function(t){t.keyCode===e.code&&(e.isUp&&e.press&&e.press(),e.isDown=!0,e.isUp=!1),t.preventDefault()},e.upHandler=function(t){t.keyCode===e.code&&(e.isDown&&e.release&&e.release(),e.isDown=!1,e.isUp=!0),t.preventDefault()},window.addEventListener("keydown",e.downHandler.bind(e),!1),window.addEventListener("keyup",e.upHandler.bind(e),!1),e}function u(t,e){return t.layer<e.layer?-1:(t.layer,e.layer,1)}return o.paused=!1,o._fps=60,o._startTime=Date.now(),o._frameDuration=1e3/o._fps,o._lag=0,o.scale=1,o.start=function(){o.setup(),h()},Object.defineProperties(o,{fps:{get:function(){return o._fps},set:function(t){o._fps=t,o._startTime=Date.now(),o._frameDuration=1e3/o._fps},enumerable:!0,configurable:!0},backgroundColor:{set:function(t){o.canvas.style.backgroundColor=t},enumerable:!0,configurable:!0}}),o.remove=function(t){var e=Array.prototype.slice.call(arguments);if(e[0]instanceof Array){var i=e[0];if(i.length>0)for(var s=i.length-1;s>=0;s--){var n=i[s];n.parent.removeChild(n),i.splice(i.indexOf(n),1)}}else e.length>1?e.forEach((function(t){t.parent.removeChild(t)})):e[0].parent.removeChild(e[0])},o.group=function(t){var e={};if(c(e),e.addChild=function(t){t.parent&&t.parent.removeChild(t),t.parent=e,e.children.push(t),e.calculateSize()},e.removeChild=function(t){if(t.parent!==e)throw new Error(t+"is not a child of "+e);e.children.splice(e.children.indexOf(t),1),e.calculateSize()},e.calculateSize=function(){e.children.length>0&&(e._newWidth=0,e._newHeight=0,e.children.forEach((function(t){t.x+t.width>e._newWidth&&(e._newWidth=t.x+t.width),t.y+t.height>e._newHeight&&(e._newHeight=t.y+t.height)})),e.width=e._newWidth,e.height=e._newHeight)},o.stage.addChild(e),t){var i=Array.prototype.slice.call(arguments);i.forEach((function(t){e.addChild(t)}))}return e},o.rectangle=function(t,e,i,s,n,r,h){var a={};return c(a),a.mask=!1,a.width=t||32,a.height=e||32,a.fillStyle=i||"red",a.strokeStyle=s||"none",a.lineWidth=n||0,a.x=r||0,a.y=h||0,o.stage.addChild(a),a.render=function(t){t.strokeStyle=a.strokeStyle,t.lineWidth=a.lineWidth,t.fillStyle=a.fillStyle,t.beginPath(),t.rect(-a.width*a.pivotX,-a.height*a.pivotY,a.width,a.height),!0===a.mask?t.clip():("none"!==a.strokeStyle&&t.stroke(),"none"!==a.fillStyle&&t.fill())},a},o.circle=function(t,e,i,s,n,r){var h={};return c(h),h.mask=!1,h.width=t||32,h.height=t||32,h.fillStyle=e||"red",h.strokeStyle=i||"none",h.lineWidth=s||"none",h.x=n||0,h.y=r||0,o.stage.addChild(h),d(h),h.render=function(t){t.strokeStyle=h.strokeStyle,t.lineWidth=h.lineWidth,t.fillStyle=h.fillStyle,t.beginPath(),t.arc(h.radius+-h.diameter*h.pivotX,h.radius+-h.diameter*h.pivotY,h.radius,0,2*Math.PI,!1),!0===h.mask?t.clip():("none"!==h.strokeStyle&&t.stroke(),"none"!==h.fillStyle&&t.fill())},h},o.text=function(t,e,i,s,n){var r={};return c(r),r.content=t||"Hello!",r.font=e||"12px sans-serif",r.fillStyle=i||"red",r.textBaseline="top",Object.defineProperties(r,{width:{get:function(){return o.canvas.ctx.measureText(r.content).width},enumerable:!0,configurable:!0},height:{get:function(){return o.canvas.ctx.measureText("M").width},enumerable:!0,configurable:!0}}),o.stage.addChild(r),r.x=s||0,r.y=n||0,r.render=function(t){t.strokeStyle=r.strokeStyle,t.lineWidth=r.lineWidth,t.fillStyle=r.fillStyle,0===r.width&&(r.width=t.measureText(r.content).width),0===r.height&&(r.height=t.measureText("M").width),t.translate(-r.width*r.pivotX,-r.height*r.pivotY),t.font=r.font,t.textBaseline=r.textBaseline,t.fillText(r.content,0,0)},r},o.render=function(t,e){var i=t.ctx;i.clearRect(0,0,t.width,t.height);for(var s=0;s<o.stage.children.length;s++){n(o.stage.children[s])}function n(e){if(e.visible&&e.gx<t.width+e.width&&e.gx+e.width>=-e.width&&e.gy<t.height+e.height&&e.gy+e.height>=-e.height){if(i.save(),e.renderX=e.x,e.renderY=e.y,i.translate(e.renderX+e.width*e.pivotX,e.renderY+e.height*e.pivotY),i.globalAlpha=e.alpha,i.rotate(e.rotation),i.scale(e.scaleX,e.scaleY),e.render&&e.render(i),e.children&&e.children.length>0){i.translate(-e.width*e.pivotX,-e.height*e.pivotY);for(var s=0;s<e.children.length;s++){n(e.children[s])}}i.restore()}}},o.keyboard=p,o.makeDisplayObject=c,void 0!==GA.plugins&&GA.plugins(o),void 0!==GA.custom&&GA.custom(o),o},window.ga=GA.create,window.GA=GA;var ga=window.ga;function internal_move(t){t.x+=0|t.vx,t.y+=0|t.vy}window.GA.custom=function(t){t.move=function(t){if(t instanceof Array==!1)internal_move(t);else for(var e=0;e<t.length;e++)internal_move(t[e])},t.fourKeyController=function(e,i,s,n,r,o){e.direction="";let h=t.keyboard(o),a=t.keyboard(s),l=t.keyboard(n),c=t.keyboard(r);h.press=function(){e.vx=-i,e.direction="left"},h.release=function(){l.isDown||(e.vx=0)},a.press=function(){e.vy=-i,e.direction="up"},a.release=function(){c.isDown||(e.vy=0)},l.press=function(){e.vx=i,e.direction="right"},l.release=function(){h.isDown||(e.vx=0)},c.press=function(){e.vy=i,e.direction="down"},c.release=function(){a.isDown||(e.vy=0)}},t.contain=function(t,e,i,s){var n,r=e.x,o=e.y,h=e.width,a=e.height;return i=i||!1,t.x<r&&(i&&(t.vx*=-1),t.mass&&(t.vx/=t.mass),t.x=r,n="left"),t.y<o&&(i&&(t.vy*=-1),t.mass&&(t.vy/=t.mass),t.y=o,n="top"),t.x+t.width>h&&(i&&(t.vx*=-1),t.mass&&(t.vx/=t.mass),t.x=h-t.width,n="right"),t.y+t.height>a&&(i&&(t.vy*=-1),t.mass&&(t.vy/=t.mass),t.y=a-t.height,n="bottom"),n&&s&&s(n),n},t.rotateAroundSprite=function(t,e,i,s){t.x=e.centerX-t.parent.x+i*Math.cos(s)-t.halfWidth,t.y=e.centerY-t.parent.y+i*Math.sin(s)},t.rotateAroundPoint=function(t,e,i,s,n){var r={};return r.x=t+Math.cos(n)*i,r.y=e+Math.sin(n)*s,r},t.followConstant=function(t,e,i){var s=e.centerX-t.centerX,n=e.centerY-t.centerY,r=Math.sqrt(s*s+n*n);r>=i&&(t.x+=s/r*i,t.y+=n/r*i)},t.hitTestRectangle=function(t,e,i){var s,n,r,o;return void 0===i&&(i=!1),!1,i?(r=t.gx+t.halfWidth-(e.gx+e.halfWidth),o=t.gy+t.halfHeight-(e.gy+e.halfHeight)):(r=t.centerX-e.centerX,o=t.centerY-e.centerY),s=t.halfWidth+e.halfWidth,n=t.halfHeight+e.halfHeight,Math.abs(r)<s&&Math.abs(o)<n},t.rectangleCollision=function(t,e,i,s){var n,r,o,h,a,l,c;return void 0===i&&(i=!1),void 0===s&&(s=!1),s?(l=t.gx+t.halfWidth-(e.gx+e.halfWidth),c=t.gy+t.halfHeight-(e.gy+e.halfHeight)):(l=t.centerX-e.centerX,c=t.centerY-e.centerY),r=t.halfWidth+e.halfWidth,o=t.halfHeight+e.halfHeight,Math.abs(l)<r&&Math.abs(c)<o&&((h=r-Math.abs(l))>=(a=o-Math.abs(c))?(c>0?(n="top",t.y=t.y+a):(n="bottom",t.y=t.y-a),i&&(t.vy*=-1)):(l>0?(n="left",t.x=t.x+h):(n="right",t.x=t.x-h),i&&(t.vx*=-1))),n},t.wait=function(t,e){return setTimeout(e,t)}};var g=ga(512,512,setup);function setup(){let t=g.canvas.style;t.border="1px black dashed",g.backgroundColor="white",t.display="block",t.margin="auto";let e=new Player(g);e.sprite.layer=5,g.player=e,g.tempo=440,g.state=new Menu(g)}g.start();
